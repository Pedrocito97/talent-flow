# Auth Flow Architecture Decision Record

**Date:** 2024-12-18
**Status:** Implemented
**Context:** Milestone 2 - Authentication system design

## Decision

Use NextAuth.js v5 (beta) with credentials provider and JWT strategy for authentication.

## Architecture

### Authentication Flow

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Login     │────>│  NextAuth   │────>│   Prisma    │
│   Page      │     │  Authorize  │     │   Database  │
└─────────────┘     └─────────────┘     └─────────────┘
       │                   │
       │                   ▼
       │            ┌─────────────┐
       │            │    JWT      │
       │            │   Token     │
       │            └─────────────┘
       │                   │
       ▼                   ▼
┌─────────────┐     ┌─────────────┐
│   Session   │<────│  Middleware │
│   Cookie    │     │   Check     │
└─────────────┘     └─────────────┘
```

### Components

1. **NextAuth Configuration** (`/lib/auth.ts`)
   - Credentials provider for email/password login
   - JWT session strategy (stateless)
   - Custom callbacks for user role injection
   - 30-day session expiration

2. **Route Handler** (`/app/api/auth/[...nextauth]/route.ts`)
   - Handles all auth-related endpoints
   - `/api/auth/signin` - Sign in
   - `/api/auth/signout` - Sign out
   - `/api/auth/session` - Get session

3. **Middleware** (`/middleware.ts`)
   - Lightweight cookie-based auth check
   - No database calls (edge-compatible)
   - Redirects unauthenticated users to /login
   - Allows public routes: /login, /invite, /api/auth

4. **Session Provider** (`/components/providers/session-provider.tsx`)
   - Wraps app in NextAuth SessionProvider
   - Enables `useSession()` hook client-side

## User Roles

```typescript
type UserRole = 'OWNER' | 'ADMIN' | 'RECRUITER' | 'VIEWER';
```

| Role | Permissions |
|------|-------------|
| OWNER | Full system access, cannot be deleted |
| ADMIN | User management, pipeline management |
| RECRUITER | Assigned pipelines, candidate management |
| VIEWER | Read-only access to assigned pipelines |

## Session Structure

```typescript
interface Session {
  user: {
    id: string;
    email: string;
    name?: string;
    role: UserRole;
  };
  expires: string;
}
```

## Security Considerations

1. **Password Hashing**: bcryptjs with 12 rounds
2. **JWT Storage**: HttpOnly secure cookies
3. **CSRF Protection**: Built into NextAuth
4. **Session Expiration**: 30 days (configurable)

## Invitation Flow (To Be Implemented)

```
Admin creates user
       │
       ▼
User record created (no password)
       │
       ▼
Email sent with invite token
       │
       ▼
User clicks link → /invite/[token]
       │
       ▼
User sets password
       │
       ▼
activatedAt set → can now login
```

## Files

- `/lib/auth.ts` - NextAuth configuration
- `/lib/db.ts` - Prisma client
- `/middleware.ts` - Auth middleware
- `/app/api/auth/[...nextauth]/route.ts` - Route handler
- `/app/(auth)/login/page.tsx` - Login page
- `/components/providers/session-provider.tsx` - Session context

## Alternatives Considered

1. **Auth.js Adapter Pattern**: Would require database calls in middleware
2. **Lucia Auth**: More manual setup, less ecosystem support
3. **Custom JWT**: More work, less secure by default

## Migration Notes

- Downgraded from Prisma 7 to Prisma 5 due to Next.js 16 Turbopack compatibility issues
- Used lightweight middleware (no database) to avoid edge runtime issues
